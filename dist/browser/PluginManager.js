function _classPrivateFieldGet(receiver,privateMap){var descriptor=_classExtractFieldDescriptor(receiver,privateMap,"get");return _classApplyDescriptorGet(receiver,descriptor)}function _classPrivateFieldSet(receiver,privateMap,value){var descriptor=_classExtractFieldDescriptor(receiver,privateMap,"set");_classApplyDescriptorSet(receiver,descriptor,value);return value}function _classExtractFieldDescriptor(receiver,privateMap,action){if(!privateMap.has(receiver)){throw new TypeError("attempted to "+action+" private field on non-instance")}return privateMap.get(receiver)}function _classApplyDescriptorGet(receiver,descriptor){if(descriptor.get){return descriptor.get.call(receiver)}return descriptor.value}function _classApplyDescriptorSet(receiver,descriptor,value){if(descriptor.set){descriptor.set.call(receiver,value)}else{if(!descriptor.writable){throw new TypeError("attempted to set read only private field")}descriptor.value=value}}function e(e,t){return function(e,t){return t.get?t.get.call(e):t.value}(e,s(e,t,"get"))}function t$1(e,t,r){return function(e,t,s){if(t.set)t.set.call(e,s);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=s}}(e,s(e,t,"set"),r),r}function s(e,t,s){if(!t.has(e))throw new TypeError("attempted to "+s+" private field on non-instance");return t.get(e)}var r=new WeakMap,n=new WeakMap;class i{constructor(){r.set(this,{writable:!0,value:void 0}),n.set(this,{writable:!0,value:void 0})}static initialize(s,o){if(void 0!==o&&"string"!=typeof o)throw new TypeError("'name' is not a string");const a=new i;return t$1(a,r,s),t$1(a,n,void 0===o?s.name:o),{destroy:function(){a.isDestroyed||(t$1(a,r,null),this&&(this.eventbusSecure=void 0))},setEventbus:function(s,i){if(void 0!==i&&"string"!=typeof i)throw new TypeError("'name' is not a string");a.isDestroyed||(void 0===i&&e(a,n)===e(a,r).name?t$1(a,n,s.name):void 0!==i&&t$1(a,n,i),t$1(a,r,s))},eventbusSecure:a}}*keys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");for(const s of e(this,r).keys(t))yield s}get isDestroyed(){return null===e(this,r)}get name(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,n)}trigger(t){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,r).trigger(...arguments),this}triggerAsync(t){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,r).triggerAsync(...arguments)}triggerDefer(t){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,r).triggerDefer(...arguments),this}triggerSync(t){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,r).triggerSync(...arguments)}}const o=/\s+/;function a(e,t,s,r,n){let i,c=0;if(s&&"object"==typeof s){void 0!==r&&"context"in n&&void 0===n.context&&(n.context=r);for(i=h(s);c<i.length;c++)t=a(e,t,i[c],s[i[c]],n)}else if(s&&o.test(s))for(i=s.split(o);c<i.length;c++)t=e(t,i[c],r,n);else t=e(t,s,r,n);return t}function c(e){const t=e.name;return""!==t?`[${t}] `:""}const h=e=>null===e||"object"!=typeof e?[]:Object.keys(e);function l(e,t,s,r){const n=r.after,i=r.count+1;if(s){const _r=e[t]=u(i,(function(){return s.apply(this,arguments)}),(()=>{n(t,_r)}));_r._callback=s}return e}const u=function u(e,t,s){let r;return function(...n){return--e>0&&(r=t.apply(this,n)),e<=1&&(s&&s.apply(this,n),s=void 0,t=void 0),r}};var f=new WeakMap,d=new WeakMap;class y{constructor(e){f.set(this,{writable:!0,value:void 0}),d.set(this,{writable:!0,value:void 0}),t$1(this,f,e)}before(t,s,r,n,i=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(!Number.isInteger(t))throw new TypeError("'count' is not an integer");const o={};if(e(this,f).isGuarded(s,o))return console.warn(`@typhonjs-plugin/eventbus ${c(this)}- before() failed as event name(s) are guarded: ${JSON.stringify(o.names)}`),this;const h=a(l,{},s,r,{count:t,after:this.off.bind(this)});return"string"==typeof s&&null==n&&(r=void 0),this.on(h,r,n,i)}createSecure(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return i.initialize(e(this,f),t)}destroy(){null!==e(this,f)&&this.off(),t$1(this,d,void 0),t$1(this,f,null)}*entries(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");for(const s of e(this,f).entries(t))yield s}get eventCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,f).eventCount}get callbackCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,f).callbackCount}*keys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");for(const s of e(this,f).keys(t))yield s}get isDestroyed(){return null===e(this,f)}get name(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return`proxy-${e(this,f).name}`}get proxyEventCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,d)?Object.keys(e(this,d)).length:0}get proxyCallbackCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(!e(this,d))return 0;let t=0;for(const s in e(this,d))t+=e(this,d)[s].length;return t}isGuarded(t,s={}){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,f).isGuarded(t,s)}off(s,r,n){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return t$1(this,d,a(g,e(this,d)||{},s,r,{context:n,eventbus:e(this,f)})),this}on(s,r,n,i=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");const o={};if(e(this,f).isGuarded(s,o))return console.warn(`@typhonjs-plugin/eventbus ${c(this)}- on() failed as event name(s) are guarded: ${JSON.stringify(o.names)}`),this;const h={context:n,ctx:this,guarded:i};return t$1(this,d,a(b,e(this,d)||{},s,r,h)),e(this,f).on(s,r,h.ctx,i),this}once(t,s,r,n=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");const i={};if(e(this,f).isGuarded(t,i))return console.warn(`@typhonjs-plugin/eventbus ${c(this)}- once() failed as event name(s) are guarded: ${JSON.stringify(i.names)}`),this;const o=a(l,{},t,s,{count:1,after:this.off.bind(this)});return"string"==typeof t&&null==r&&(s=void 0),this.on(o,s,r,n)}*proxyEntries(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,d))if(t){for(const s in e(this,d))if(t.test(s))for(const _t of e(this,d)[s])yield[s,_t.callback,_t.context,_t.guarded]}else for(const _t2 in e(this,d))for(const s of e(this,d)[_t2])yield[_t2,s.callback,s.context,s.guarded]}*proxyKeys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,d))if(t)for(const s in e(this,d))t.test(s)&&(yield s);else for(const _t3 in e(this,d))yield _t3}trigger(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,f).trigger(...arguments),this}triggerAsync(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,f).triggerAsync(...arguments)}triggerDefer(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,f).triggerDefer(...arguments),this}triggerSync(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,f).triggerSync(...arguments)}}const g=(e,t,s,r)=>{if(!e)return;const n=r.context,i=r.eventbus,o=t?[t]:h(e);for(let _r2=0;_r2<o.length;_r2++){const a=e[t=o[_r2]];if(!a)break;const c=[];for(let _e=0;_e<a.length;_e++){const _t4=a[_e];(s&&s!==_t4.callback&&s!==_t4.callback._callback||n&&n!==_t4.context)&&c.push(_t4)}c.length?e[t]=c:(i.off(t,s,n),delete e[t])}return e},b=(e,t,s,r)=>{if(s){const n=e[t]||(e[t]=[]),i=r.context,o=r.ctx,a="boolean"==typeof r.guarded&&r.guarded;r.ctx=i||o,n.push({callback:s,context:i,ctx:r.ctx,guarded:a})}return e};var v=new WeakMap,w=new WeakMap;class p{constructor(e=""){if(v.set(this,{writable:!0,value:""}),w.set(this,{writable:!0,value:void 0}),"string"!=typeof e)throw new TypeError("'name' is not a string");t$1(this,v,e),this._listeners=void 0,this._listenId=void 0,this._listeningTo=void 0}before(e,t,s,r,n=!1){if(!Number.isInteger(e))throw new TypeError("'count' is not an integer");const i={};if(this.isGuarded(t,i))return console.warn(`@typhonjs-plugin/eventbus ${c(this)}- before() failed as event name(s) are guarded: ${JSON.stringify(i.names)}`),this;const o=a(l,{},t,s,{count:e,after:this.off.bind(this)});return"string"==typeof t&&null==r&&(s=void 0),this.on(o,s,r,n)}createProxy(){return new y(this)}createSecure(e){return i.initialize(this,e)}*entries(t){if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,w))if(t){for(const s in e(this,w))if(t.test(s))for(const _t5 of e(this,w)[s])yield[s,_t5.callback,_t5.context,_t5.guarded]}else for(const _t6 in e(this,w))for(const s of e(this,w)[_t6])yield[_t6,s.callback,s.context,s.guarded]}get eventCount(){return e(this,w)?Object.keys(e(this,w)).length:0}get callbackCount(){if(!e(this,w))return 0;let t=0;for(const s in e(this,w))t+=e(this,w)[s].length;return t}isGuarded(t,s={}){return s.names=[],s.guarded=!1,a(S,s,t,void 0,{events:e(this,w)}).guarded}*keys(t){if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,w))if(t)for(const s in e(this,w))t.test(s)&&(yield s);else for(const _t7 in e(this,w))yield _t7}get name(){return e(this,v)}listenTo(e,t,s){if(!e)return this;const r={};if(I(e,t,r))return console.warn(`@typhonjs-plugin/eventbus ${c(this)}- listenTo() failed as event name(s) are guarded for target object: ${JSON.stringify(r.names)}`),this;const n=e._listenId||(e._listenId=N("l")),i=this._listeningTo||(this._listeningTo={});let o=x=i[n];o||(this._listenId||(this._listenId=N("l")),o=x=i[n]=new P(this,e));const a=O(e,t,s,this);if(x=void 0,a)throw a;return o.interop&&o.on(t,s),this}listenToBefore(e,t,s,r){if(!Number.isInteger(e))throw new TypeError("'count' is not an integer");const n=a(l,{},s,r,{count:e,after:this.stopListening.bind(this,t)});return this.listenTo(t,n)}listenToOnce(e,t,s){const r=a(l,{},t,s,{count:1,after:this.stopListening.bind(this,e)});return this.listenTo(e,r)}off(s,r,n){return e(this,w)?(t$1(this,w,a(_,e(this,w),s,r,{context:n,listeners:this._listeners})),this):this}on(s,r,n,i=!1){const o={};return this.isGuarded(s,o)?(console.warn(`@typhonjs-plugin/eventbus ${c(this)}- on() failed as event name(s) are guarded: ${JSON.stringify(o.names)}`),this):(t$1(this,w,a(A,e(this,w)||{},s,r,{context:n,ctx:this,guarded:i,listening:x})),x&&((this._listeners||(this._listeners={}))[x.id]=x,x.interop=!1),this)}once(e,t,s,r=!1){const n={};if(this.isGuarded(e,n))return console.warn(`@typhonjs-plugin/eventbus ${c(this)}- once() failed as event name(s) are guarded: ${JSON.stringify(n.names)}`),this;const i=a(l,{},e,t,{count:1,after:this.off.bind(this)});return"string"==typeof e&&null==s&&(t=void 0),this.on(i,t,s,r)}stopListening(e,t,s){const r=this._listeningTo;if(!r)return this;const n=e?[e._listenId]:h(r);for(let _e2=0;_e2<n.length;_e2++){const i=r[n[_e2]];if(!i)break;i.obj.off(t,s,this),i.interop&&i.off(t,s)}return this}trigger(t){if(!e(this,w))return this;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];return $(j,M,e(this,w),t,void 0,r),this}async triggerAsync(t){if(!e(this,w))return;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];const n=$(j,W,e(this,w),t,void 0,r);return void 0!==n?Array.isArray(n)?Promise.all(n).then((e=>{let t=[];for(const s of e)Array.isArray(s)?t=t.concat(s):void 0!==s&&t.push(s);return t.length>1?t:1===t.length?t[0]:void 0})):n:void 0}triggerDefer(e){return setTimeout((()=>{this.trigger(...arguments)}),0),this}triggerSync(t){if(!e(this,w))return;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];return $(j,C,e(this,w),t,void 0,r)}}let x;var E=new WeakMap,k=new WeakMap,T=new WeakMap,m=new WeakMap,D=new WeakMap,R=new WeakMap;class P{constructor(e,s){E.set(this,{writable:!0,value:void 0}),k.set(this,{writable:!0,value:void 0}),T.set(this,{writable:!0,value:void 0}),m.set(this,{writable:!0,value:void 0}),D.set(this,{writable:!0,value:void 0}),R.set(this,{writable:!0,value:0}),t$1(this,k,e._listenId),t$1(this,T,e),t$1(this,m,s),t$1(this,D,!0)}cleanup(){delete e(this,T)._listeningTo[e(this,m)._listenId],e(this,D)||delete e(this,m)._listeners[e(this,k)]}get id(){return e(this,k)}get interop(){return e(this,D)}get obj(){return e(this,m)}incrementCount(){t$1(this,R,+e(this,R)+1)}on(s,r,n){return t$1(this,E,a(A,e(this,E)||{},s,r,{context:n,ctx:this,listening:this})),this}off(s,r){let n;e(this,D)?(t$1(this,E,a(_,e(this,E),s,r,{context:void 0,listeners:void 0})),n=!e(this,E)):(t$1(this,R,+e(this,R)-1),n=0===e(this,R)),n&&this.cleanup()}set interop(e){if("boolean"!=typeof e)throw new TypeError("'value' is not a boolean");t$1(this,D,e)}}const S=(e,t,s,r)=>{const n=r.events;if(n){const _s=n[t];if(Array.isArray(_s))for(const _r3 of _s)if(_r3.guarded)return e.names.push(t),e.guarded=!0,e}return e},_=(e,t,s,r)=>{if(!e)return;const n=r.context,i=r.listeners;let o,a=0;if(t||n||s){for(o=t?[t]:h(e);a<o.length;a++){const _r4=e[t=o[a]];if(!_r4)break;const _i=[];for(let _e3=0;_e3<_r4.length;_e3++){const _o=_r4[_e3];if(s&&s!==_o.callback&&s!==_o.callback._callback||n&&n!==_o.context)_i.push(_o);else{const _e4=_o.listening;_e4&&_e4.off(t,s)}}_i.length?e[t]=_i:delete e[t]}return e}for(o=h(i);a<o.length;a++)i[o[a]].cleanup()},A=(e,t,s,r)=>{if(s){const n=e[t]||(e[t]=[]),i=r.context,o=r.ctx,a=r.listening,c="boolean"==typeof r.guarded&&r.guarded;a&&a.incrementCount(),n.push({callback:s,context:i,ctx:i||o,guarded:c,listening:a})}return e},$=(e,t,s,r,n,i)=>{let a,c,h=0;if(r&&o.test(r))for(c=r.split(o);h<c.length;h++){const _r5=e(t,s,c[h],n,i),o=Array.isArray(a)?2:void 0!==a?1:0;if(Array.isArray(_r5))switch(o){case 0:a=_r5;break;case 1:a=[a].concat(_r5);break;case 2:a=a.concat(_r5)}else if(void 0!==_r5)switch(o){case 0:a=_r5;break;case 1:{const _e5=[a];_e5.push(_r5),a=_e5;break}case 2:a.push(_r5)}}else a=e(t,s,r,n,i);return a},j=(e,t,s,r,n)=>{let i;if(t){const _r6=t[s];let o=t.all;_r6&&o&&(o=o.slice()),_r6&&(i=e(_r6,n)),o&&(i=e(o,[s].concat(n)))}return i},M=(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length;switch(t.length){case 0:for(;++r<a;)(s=e[r]).callback.call(s.ctx);return;case 1:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n);return;case 2:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n,i);return;case 3:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n,i,o);return;default:for(;++r<a;)(s=e[r]).callback.apply(s.ctx,t);return}},W=async(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length,c=[];switch(t.length){case 0:for(;++r<a;){const _t8=(s=e[r]).callback.call(s.ctx);void 0!==_t8&&c.push(_t8)}break;case 1:for(;++r<a;){const _t9=(s=e[r]).callback.call(s.ctx,n);void 0!==_t9&&c.push(_t9)}break;case 2:for(;++r<a;){const _t10=(s=e[r]).callback.call(s.ctx,n,i);void 0!==_t10&&c.push(_t10)}break;case 3:for(;++r<a;){const _t11=(s=e[r]).callback.call(s.ctx,n,i,o);void 0!==_t11&&c.push(_t11)}break;default:for(;++r<a;){const _n=(s=e[r]).callback.apply(s.ctx,t);void 0!==_n&&c.push(_n)}}return c.length>1?Promise.all(c).then((e=>{const t=e.filter((e=>void 0!==e));switch(t.length){case 0:return;case 1:return t[0];default:return t}})):1===c.length?c[0]:void 0},C=(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length,c=[];switch(t.length){case 0:for(;++r<a;){const _t12=(s=e[r]).callback.call(s.ctx);void 0!==_t12&&c.push(_t12)}break;case 1:for(;++r<a;){const _t13=(s=e[r]).callback.call(s.ctx,n);void 0!==_t13&&c.push(_t13)}break;case 2:for(;++r<a;){const _t14=(s=e[r]).callback.call(s.ctx,n,i);void 0!==_t14&&c.push(_t14)}break;case 3:for(;++r<a;){const _t15=(s=e[r]).callback.call(s.ctx,n,i,o);void 0!==_t15&&c.push(_t15)}break;default:for(;++r<a;){const _n2=(s=e[r]).callback.apply(s.ctx,t);void 0!==_n2&&c.push(_n2)}}return c.length>1?c:1===c.length?c[0]:void 0},I=(e,t,s={})=>{let r=!1;try{const n=e.isGuarded(t,s);"boolean"==typeof n&&(r=n)}catch(e){r=!1,s.names=[],s.guarded=!1}return r},O=(e,t,s,r)=>{try{e.on(t,s,r)}catch(e){return e}};let G=0;const N=(e="")=>{const t=""+ ++G;return e?`${e}${t}`:t},J=new p("mainEventbus"),z=new p("pluginEventbus"),L=new p("testEventbus");const t=/^(https?:\/\/|file:\/\/)/;class ModuleLoader{static async load({modulepath:o,resolveModule:e}={}){if(!(o instanceof URL)&&"string"!=typeof o)throw new TypeError("'modulepath' is not a string or URL");if(void 0!==e&&"function"!=typeof e)throw new TypeError("'resolveModule' is not a function");const n=await import(o),i=o instanceof URL?o.toString():o,a="import-"+(o instanceof URL||"string"==typeof o&&o.match(t)?"url":"path");return{filepath:i,instance:void 0!==e?e(n):n,isESM:!0,loadpath:i,module:n,modulepath:o,type:a}}}var _data=new WeakMap;var _enabled=new WeakMap;var _name=new WeakMap;var _instance=new WeakMap;var _eventbusProxy=new WeakMap;var _events=new WeakMap;class PluginEntry{constructor(name,data,instance,eventbusProxy=void 0){_data.set(this,{writable:true,value:void 0});_enabled.set(this,{writable:true,value:void 0});_name.set(this,{writable:true,value:void 0});_instance.set(this,{writable:true,value:void 0});_eventbusProxy.set(this,{writable:true,value:void 0});_events.set(this,{writable:true,value:void 0});_classPrivateFieldSet(this,_data,data);_classPrivateFieldSet(this,_enabled,true);_classPrivateFieldSet(this,_name,name);_classPrivateFieldSet(this,_instance,instance);_classPrivateFieldSet(this,_eventbusProxy,eventbusProxy)}get data(){return _classPrivateFieldGet(this,_data)}get enabled(){return _classPrivateFieldGet(this,_enabled)}set enabled(enabled){_classPrivateFieldSet(this,_enabled,enabled);if(enabled){if(_classPrivateFieldGet(this,_eventbusProxy)!==void 0&&Array.isArray(_classPrivateFieldGet(this,_events))){for(const event of _classPrivateFieldGet(this,_events)){_classPrivateFieldGet(this,_eventbusProxy).on(...event)}_classPrivateFieldSet(this,_events,void 0)}}else{if(_classPrivateFieldGet(this,_eventbusProxy)!==void 0){_classPrivateFieldSet(this,_events,Array.from(_classPrivateFieldGet(this,_eventbusProxy).proxyEntries()));_classPrivateFieldGet(this,_eventbusProxy).off()}}}get eventbusProxy(){return _classPrivateFieldGet(this,_eventbusProxy)}get instance(){return _classPrivateFieldGet(this,_instance)}get name(){return _classPrivateFieldGet(this,_name)}set eventbusProxy(eventbusProxy){_classPrivateFieldSet(this,_eventbusProxy,eventbusProxy)}}function deepFreeze(data,skipFreezeKeys=[]){if(typeof data!=="object"){throw new TypeError(`'data' is not an 'object'.`)}if(!Array.isArray(skipFreezeKeys)){throw new TypeError(`'skipFreezeKeys' is not an 'array'.`)}return _deepFreeze(data,skipFreezeKeys)}function isIterable(object){if(object===null||object===void 0||typeof object!=="object"){return false}return typeof object[Symbol.iterator]==="function"}function isObject(object){return object!==null&&typeof object==="object"}function _deepFreeze(data,skipFreezeKeys){if(Array.isArray(data)){for(let cntr=0;cntr<data.length;cntr++){_deepFreeze(data[cntr],skipFreezeKeys)}}else if(typeof data==="object"){for(const key in data){if(data.hasOwnProperty(key)&&!skipFreezeKeys.includes(key)){_deepFreeze(data[key],skipFreezeKeys)}}}return Object.freeze(data)}class PluginInvokeEvent{constructor(copyProps={},passthruProps={}){this.data=Object.assign(JSON.parse(JSON.stringify(copyProps)),passthruProps);this.eventbus=void 0;this.pluginName=void 0;this.pluginOptions=void 0}}async function invokeAsyncEvent({method,manager,copyProps={},passthruProps={},plugins=void 0,options=void 0,errorCheck=true}={}){if(typeof method!=="string"){throw new TypeError(`'method' is not a string.`)}if(typeof passthruProps!=="object"){throw new TypeError(`'passthruProps' is not an object.`)}if(typeof copyProps!=="object"){throw new TypeError(`'copyProps' is not an object.`)}if(options===void 0){options=manager.getOptions()}if(plugins===void 0){plugins=manager.getPluginMapKeys()}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}let pluginInvokeCount=0;const pluginInvokeNames=[];let hasMethod=false;let hasPlugin=false;const ev=new PluginInvokeEvent(copyProps,passthruProps);const results=[];if(typeof plugins==="string"){const entry=manager.getPluginEntry(plugins);if(entry!==void 0&&entry.enabled&&entry.instance){hasPlugin=true;if(typeof entry.instance[method]==="function"){ev.eventbus=entry.eventbusProxy;ev.pluginName=entry.name;ev.pluginOptions=entry.data.plugin.options;const result=entry.instance[method](ev);if(typeof result!=="undefined"&&result!==null){results.push(result)}hasMethod=true;pluginInvokeCount++;pluginInvokeNames.push(entry.name)}}}else{for(const name of plugins){const entry=manager.getPluginEntry(name);if(entry!==void 0&&entry.enabled&&entry.instance){hasPlugin=true;if(typeof entry.instance[method]==="function"){ev.eventbus=entry.eventbusProxy;ev.pluginName=entry.name;ev.pluginOptions=entry.data.plugin.options;const result=entry.instance[method](ev);if(typeof result!=="undefined"&&result!==null){results.push(result)}hasMethod=true;pluginInvokeCount++;pluginInvokeNames.push(entry.name)}}}}if(errorCheck&&options.throwNoPlugin&&!hasPlugin){throw new Error(`PluginManager failed to find any target plugins.`)}if(errorCheck&&options.throwNoMethod&&!hasMethod){throw new Error(`PluginManager failed to invoke '${method}'.`)}ev.data.$$plugin_invoke_count=pluginInvokeCount;ev.data.$$plugin_invoke_names=pluginInvokeNames;await Promise.all(results);return ev.data}const s_REGEX_ESCAPE_RELATIVE=/^([.]{1,2}[\\|/])+/g;const s_REGEX_ESCAPE_FORWARD=/[\\]/g;const s_REGEX_STRING_URL=/^(https?|file):/g;function escapeTarget(target){let targetEscaped=target;if(target instanceof URL){targetEscaped=target.pathname}else if(target.match(s_REGEX_STRING_URL)){targetEscaped=new URL(target).pathname}targetEscaped=targetEscaped.replace(s_REGEX_ESCAPE_RELATIVE,"");targetEscaped=targetEscaped.replace(s_REGEX_ESCAPE_FORWARD,"\\\\");return targetEscaped}function isValidConfig(pluginConfig){if(typeof pluginConfig!=="object"){return false}if(typeof pluginConfig.name!=="string"){return false}if(typeof pluginConfig.target!=="undefined"&&typeof pluginConfig.target!=="string"&&!(pluginConfig.target instanceof URL)){return false}if(typeof pluginConfig.options!=="undefined"&&typeof pluginConfig.options!=="object"){return false}return true}function resolveModule(module){if(typeof module.onPluginLoad==="function"){return module}else if(module.default){return module.default}else{return module}}var _eventbus=new WeakMap;var _eventbusProxies=new WeakMap;var _eventbusSecure=new WeakMap;var _options=new WeakMap;var _pluginMap=new WeakMap;var _pluginSupport=new WeakMap;class PluginManager{constructor(options={}){_eventbus.set(this,{writable:true,value:null});_eventbusProxies.set(this,{writable:true,value:[]});_eventbusSecure.set(this,{writable:true,value:[]});_options.set(this,{writable:true,value:{noEventAdd:false,noEventDestroy:true,noEventRemoval:false,noEventSetEnabled:true,noEventSetOptions:true,throwNoMethod:false,throwNoPlugin:false}});_pluginMap.set(this,{writable:true,value:new Map});_pluginSupport.set(this,{writable:true,value:[]});if(!isObject(options)){throw new TypeError(`'options' is not an object.`)}if(options.eventbus!==void 0&&!isObject(options.eventbus)){throw new TypeError(`'options.eventbus' is not an Eventbus.`)}if(options.eventPrepend!==void 0&&typeof options.eventPrepend!=="string"){throw new TypeError(`'options.eventPrepend' is not a string.`)}if(options.manager!==void 0&&!isObject(options.manager)){throw new TypeError(`'options.manager' is not an object.`)}if(options.PluginSupport!==void 0&&typeof options.PluginSupport!=="function"&&!isIterable(options.PluginSupport)){throw new TypeError(`'options.PluginSupport' must be a constructor function or iterable of such matching PluginSupportImpl.`)}if(isIterable(options.PluginSupport)){for(const PluginSupport of options.PluginSupport){_classPrivateFieldGet(this,_pluginSupport).push(new PluginSupport(this))}}else if(options.PluginSupport!==void 0){_classPrivateFieldGet(this,_pluginSupport).push(new options.PluginSupport(this))}this.setOptions(options.manager);this.setEventbus({eventbus:options.eventbus!==void 0?options.eventbus:new p,eventPrepend:options.eventPrepend})}async add(pluginConfig,moduleData){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof pluginConfig!=="object"){throw new TypeError(`'pluginConfig' is not an object.`)}if(typeof pluginConfig.name!=="string"){throw new TypeError(`'pluginConfig.name' is not a string for entry:\n${JSON.stringify(pluginConfig,null,3)}`)}if(pluginConfig.target!==void 0&&typeof pluginConfig.target!=="string"&&!(pluginConfig.target instanceof URL)){throw new TypeError(`'pluginConfig.target' is not a string or URL for entry:\n${JSON.stringify(pluginConfig,null,3)}`)}if(pluginConfig.options!==void 0&&typeof pluginConfig.options!=="object"){throw new TypeError(`'pluginConfig.options' is not an object for entry:\n${JSON.stringify(pluginConfig,null,3)}`)}if(moduleData!==void 0&&typeof moduleData!=="object"){throw new TypeError(`'moduleData' is not an object for entry:\n${JSON.stringify(pluginConfig,null,3)}`)}if(_classPrivateFieldGet(this,_pluginMap).has(pluginConfig.name)){throw new Error(`A plugin already exists with name: ${pluginConfig.name} for entry:\n${JSON.stringify(pluginConfig,null,3)}`)}let instance,target,type;if(typeof pluginConfig.instance==="object"||typeof pluginConfig.instance==="function"){instance=pluginConfig.instance;target=pluginConfig.name;type="instance"}else{target=pluginConfig.target||pluginConfig.name;try{const result=await ModuleLoader.load({modulepath:target,resolveModule});if(_classPrivateFieldGet(this,_eventbus)!==null){_classPrivateFieldGet(this,_eventbus).trigger("log:debug",`@typhonjs-plugin/manager - ${result.isESM?"import":"require"}: ${result.loadpath}`)}instance=result.instance;type=result.type}catch(err){throw new Error(`@typhonjs-plugin/manager - Could not load target: ${target}\n\nPluginConfig:\n`+`${JSON.stringify(pluginConfig,null,3)}\n\n${err}`)}}if(target instanceof URL){target=target.toString()}const pluginData=JSON.parse(JSON.stringify({manager:{eventPrepend:this._eventPrepend,scopedName:`${this._eventPrepend}:${pluginConfig.name}`},module:moduleData||{},plugin:{name:pluginConfig.name,target,targetEscaped:escapeTarget(target),type,options:pluginConfig.options||{}}}));deepFreeze(pluginData,["manager"]);const eventbusProxy=_classPrivateFieldGet(this,_eventbus)!==null&&_classPrivateFieldGet(this,_eventbus)!==void 0?new y(_classPrivateFieldGet(this,_eventbus)):void 0;const entry=new PluginEntry(pluginConfig.name,pluginData,instance,eventbusProxy);_classPrivateFieldGet(this,_pluginMap).set(pluginConfig.name,entry);await invokeAsyncEvent({method:"onPluginLoad",manager:this,plugins:pluginConfig.name,errorCheck:false});if(_classPrivateFieldGet(this,_eventbus)){await _classPrivateFieldGet(this,_eventbus).triggerAsync(`typhonjs:plugin:manager:plugin:added`,pluginData)}return pluginData}async addAll(pluginConfigs=[],moduleData){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(!isIterable(pluginConfigs)){throw new TypeError(`'pluginConfigs' is not iterable.`)}const pluginsData=[];for(const pluginConfig of pluginConfigs){const result=await this.add(pluginConfig,moduleData);if(result){pluginsData.push(result)}}return pluginsData}async _addEventbus(pluginConfig,moduleData){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return!_classPrivateFieldGet(this,_options).noEventAdd?this.add(pluginConfig,moduleData):void 0}async _addAllEventbus(pluginConfigs,moduleData){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return!_classPrivateFieldGet(this,_options).noEventAdd?this.addAll(pluginConfigs,moduleData):[]}createEventbusProxy(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(_classPrivateFieldGet(this,_eventbus)===null){throw new ReferenceError("No eventbus assigned to plugin manager.")}const eventbusProxy=new y(_classPrivateFieldGet(this,_eventbus));_classPrivateFieldGet(this,_eventbusProxies).push(eventbusProxy);return eventbusProxy}createEventbusSecure(name=void 0){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(_classPrivateFieldGet(this,_eventbus)===null){throw new ReferenceError("No eventbus assigned to plugin manager.")}const eventbusSecureObj=_classPrivateFieldGet(this,_eventbus).createSecure(name);_classPrivateFieldGet(this,_eventbusSecure).push(eventbusSecureObj);return eventbusSecureObj.eventbusSecure}async destroy(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}for(const eventbusSecureObj of _classPrivateFieldGet(this,_eventbusSecure)){eventbusSecureObj.destroy()}_classPrivateFieldSet(this,_eventbusSecure,[]);for(const eventbusProxy of _classPrivateFieldGet(this,_eventbusProxies)){eventbusProxy.destroy()}_classPrivateFieldSet(this,_eventbusProxies,[]);const results=await this.removeAll();if(_classPrivateFieldGet(this,_eventbus)!==null&&_classPrivateFieldGet(this,_eventbus)!==void 0){_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:async:add`,this._addEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:async:add:all`,this._addAllEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:async:destroy:manager`,this._destroyEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:async:remove`,this._removeEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:async:remove:all`,this._removeAllEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:get:enabled`,this.getEnabled,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:get:plugin:by:event`,this.getPluginByEvent,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:get:plugin:data`,this.getPluginData,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:get:plugin:events`,this.getPluginEvents,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:get:plugin:names`,this.getPluginNames,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:get:options`,this.getOptions,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:has:plugin`,this.hasPlugins,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:is:valid:config`,this.isValidConfig,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:set:enabled`,this._setEnabledEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${this._eventPrepend}:set:options`,this._setOptionsEventbus,this)}for(const pluginSupport of _classPrivateFieldGet(this,_pluginSupport)){await pluginSupport.destroy({eventbus:_classPrivateFieldGet(this,_eventbus),eventPrepend:this._eventPrepend})}_classPrivateFieldSet(this,_pluginSupport,[]);_classPrivateFieldSet(this,_pluginMap,null);_classPrivateFieldSet(this,_eventbus,null);return results}async _destroyEventbus(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return!_classPrivateFieldGet(this,_options).noEventDestroy?this.destroy():[]}get isDestroyed(){return _classPrivateFieldGet(this,_pluginMap)===null||_classPrivateFieldGet(this,_pluginMap)===void 0}getEnabled({plugins=[]}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}if(typeof plugins==="string"){const entry=_classPrivateFieldGet(this,_pluginMap).get(plugins);return entry!==void 0&&entry.enabled}const results=[];let count=0;for(const plugin of plugins){const entry=_classPrivateFieldGet(this,_pluginMap).get(plugin);const loaded=entry!==void 0;results.push({plugin,enabled:loaded&&entry.enabled,loaded});count++}if(count===0){for(const[plugin,entry]of _classPrivateFieldGet(this,_pluginMap).entries()){const loaded=entry!==void 0;results.push({plugin,enabled:loaded&&entry.enabled,loaded})}}return results}getEventbus(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return _classPrivateFieldGet(this,_eventbus)}getOptions(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return JSON.parse(JSON.stringify(_classPrivateFieldGet(this,_options)))}getPluginByEvent({event=void 0}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof event!=="string"&&!(event instanceof RegExp)){throw new TypeError(`'event' is not a string or RegExp.`)}const pluginEvents=this.getPluginEvents();const results=[];if(typeof event==="string"){for(const entry of pluginEvents){if(entry.events.includes(event)){results.push(entry.plugin)}}}else{for(const entry of pluginEvents){for(const eventEntry of entry.events){if(event.test(eventEntry)){results.push(entry.plugin);break}}}}return results}getPluginData({plugins=[]}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}if(typeof plugins==="string"){const entry=_classPrivateFieldGet(this,_pluginMap).get(plugins);return entry!==void 0?JSON.parse(JSON.stringify(entry.data)):void 0}const results=[];let count=0;for(const name of plugins){const entry=_classPrivateFieldGet(this,_pluginMap).get(name);if(entry!==void 0){results.push(JSON.parse(JSON.stringify(entry.data)))}count++}if(count===0){for(const entry of _classPrivateFieldGet(this,_pluginMap).values()){if(entry!==void 0){results.push(JSON.parse(JSON.stringify(entry.data)))}}}return results}getPluginEntry(plugin){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return _classPrivateFieldGet(this,_pluginMap).get(plugin)}getPluginEvents({plugins=[]}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}if(typeof plugins==="string"){const entry=_classPrivateFieldGet(this,_pluginMap).get(plugins);return entry!==void 0&&entry.eventbusProxy?Array.from(entry.eventbusProxy.proxyKeys()).sort():[]}const results=[];let count=0;for(const plugin of plugins){const entry=_classPrivateFieldGet(this,_pluginMap).get(plugin);if(entry!==void 0){results.push({plugin,events:entry.eventbusProxy?Array.from(entry.eventbusProxy.proxyKeys()).sort():[]})}count++}if(count===0){for(const entry of _classPrivateFieldGet(this,_pluginMap).values()){if(entry!==void 0){results.push({plugin:entry.name,events:entry.eventbusProxy?Array.from(entry.eventbusProxy.proxyKeys()).sort():[]})}}}return results}getPluginMapKeys(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return _classPrivateFieldGet(this,_pluginMap).keys()}getPluginMapValues(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return _classPrivateFieldGet(this,_pluginMap).values()}getPluginNames({enabled=void 0}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(enabled!==void 0&&typeof enabled!=="boolean"){throw new TypeError(`'enabled' is not a boolean.`)}const anyEnabledState=enabled===void 0;const results=[];for(const entry of _classPrivateFieldGet(this,_pluginMap).values()){if(anyEnabledState||entry.enabled===enabled){results.push(entry.name)}}return results.sort()}hasPlugins({plugins=[]}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}if(typeof plugins==="string"){return _classPrivateFieldGet(this,_pluginMap).has(plugins)}let count=0;for(const name of plugins){if(!_classPrivateFieldGet(this,_pluginMap).has(name)){return false}count++}if(count===0){return _classPrivateFieldGet(this,_pluginMap).size!==0}return true}isValidConfig(pluginConfig){return isValidConfig(pluginConfig)}async remove({plugins=[]}={}){var _this=this;if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}const removeEntry=async function removeEntry(entry){const errors=[];const pluginName=entry.name;try{await invokeAsyncEvent({method:"onPluginUnload",manager:_this,plugins:pluginName,errorCheck:false})}catch(err){errors.push(err)}try{entry.instance._eventbus=void 0}catch(err){}if(entry.eventbusProxy instanceof y){entry.eventbusProxy.destroy()}_classPrivateFieldGet(_this,_pluginMap).delete(pluginName);try{if(_classPrivateFieldGet(_this,_eventbus)){await _classPrivateFieldGet(_this,_eventbus).triggerAsync(`typhonjs:plugin:manager:plugin:removed`,JSON.parse(JSON.stringify(entry.data)))}}catch(err){errors.push(err)}return{plugin:pluginName,success:errors.length===0,errors}};const results=[];if(typeof plugins==="string"){const entry=_classPrivateFieldGet(this,_pluginMap).get(plugins);if(entry!==void 0){results.push(await removeEntry(entry))}}else{for(const name of plugins){const entry=_classPrivateFieldGet(this,_pluginMap).get(name);if(entry!==void 0){results.push(await removeEntry(entry))}}}return results}async removeAll(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return this.remove({plugins:Array.from(_classPrivateFieldGet(this,_pluginMap).keys())})}async _removeEventbus(opts){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return!_classPrivateFieldGet(this,_options).noEventRemoval?this.remove(opts):[]}async _removeAllEventbus(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return!_classPrivateFieldGet(this,_options).noEventRemoval?this.removeAll():[]}setEnabled({enabled,plugins=[]}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}if(typeof enabled!=="boolean"){throw new TypeError(`'enabled' is not a boolean.`)}const setEntryEnabled=entry=>{if(entry!==void 0){entry.enabled=enabled;if(_classPrivateFieldGet(this,_eventbus)){_classPrivateFieldGet(this,_eventbus).trigger(`typhonjs:plugin:manager:plugin:enabled`,Object.assign({enabled},JSON.parse(JSON.stringify(entry.data))))}}};if(typeof plugins==="string"){setEntryEnabled(_classPrivateFieldGet(this,_pluginMap).get(plugins))}let count=0;for(const name of plugins){setEntryEnabled(_classPrivateFieldGet(this,_pluginMap).get(name));count++}if(count===0){for(const entry of _classPrivateFieldGet(this,_pluginMap).values()){setEntryEnabled(entry)}}}_setEnabledEventbus(opts){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(!_classPrivateFieldGet(this,_options).noEventSetEnabled){this.setEnabled(opts)}}async setEventbus({eventbus,eventPrepend="plugins"}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(!isObject(eventbus)){throw new TypeError(`'eventbus' is not an Eventbus.`)}if(typeof eventPrepend!=="string"){throw new TypeError(`'eventPrepend' is not a string.`)}if(eventbus===_classPrivateFieldGet(this,_eventbus)){return}const oldPrepend=this._eventPrepend;this._eventPrepend=eventPrepend;if(_classPrivateFieldGet(this,_pluginMap).size>0){await invokeAsyncEvent({method:"onPluginUnload",manager:this,errorCheck:false});for(const entry of _classPrivateFieldGet(this,_pluginMap).values()){try{entry.instance._eventbus=void 0}catch(err){}entry.data.manager.eventPrepend=eventPrepend;entry.data.manager.scopedName=`${eventPrepend}:${entry.name}`;if(entry.eventbusProxy instanceof y){entry.eventbusProxy.destroy()}entry.eventbusProxy=new y(eventbus)}await invokeAsyncEvent({method:"onPluginLoad",manager:this,errorCheck:false})}if(_classPrivateFieldGet(this,_eventbus)!==null){_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:async:add`,this._addEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:async:add:all`,this._addAllEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:async:destroy:manager`,this._destroyEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:async:remove`,this._removeEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:async:remove:all`,this._removeAllEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:get:enabled`,this.getEnabled,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:get:options`,this.getOptions,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:get:plugin:by:event`,this.getPluginByEvent,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:get:plugin:data`,this.getPluginData,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:get:plugin:events`,this.getPluginEvents,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:get:plugin:names`,this.getPluginNames,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:has:plugin`,this.hasPlugins,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:is:valid:config`,this.isValidConfig,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:set:enabled`,this._setEnabledEventbus,this);_classPrivateFieldGet(this,_eventbus).off(`${oldPrepend}:set:options`,this._setOptionsEventbus,this)}eventbus.on(`${eventPrepend}:async:add`,this._addEventbus,this,true);eventbus.on(`${eventPrepend}:async:add:all`,this._addAllEventbus,this,true);eventbus.on(`${eventPrepend}:async:destroy:manager`,this._destroyEventbus,this,true);eventbus.on(`${eventPrepend}:async:remove`,this._removeEventbus,this,true);eventbus.on(`${eventPrepend}:async:remove:all`,this._removeAllEventbus,this,true);eventbus.on(`${eventPrepend}:get:enabled`,this.getEnabled,this,true);eventbus.on(`${eventPrepend}:get:options`,this.getOptions,this,true);eventbus.on(`${eventPrepend}:get:plugin:by:event`,this.getPluginByEvent,this,true);eventbus.on(`${eventPrepend}:get:plugin:data`,this.getPluginData,this,true);eventbus.on(`${eventPrepend}:get:plugin:events`,this.getPluginEvents,this,true);eventbus.on(`${eventPrepend}:get:plugin:names`,this.getPluginNames,this,true);eventbus.on(`${eventPrepend}:has:plugin`,this.hasPlugins,this,true);eventbus.on(`${eventPrepend}:is:valid:config`,this.isValidConfig,this,true);eventbus.on(`${eventPrepend}:set:enabled`,this._setEnabledEventbus,this,true);eventbus.on(`${eventPrepend}:set:options`,this._setOptionsEventbus,this,true);for(const pluginSupport of _classPrivateFieldGet(this,_pluginSupport)){pluginSupport.setEventbus({oldEventbus:_classPrivateFieldGet(this,_eventbus),newEventbus:eventbus,oldPrepend,newPrepend:eventPrepend})}for(const eventbusSecureObj of _classPrivateFieldGet(this,_eventbusSecure)){eventbusSecureObj.setEventbus(eventbus)}_classPrivateFieldSet(this,_eventbus,eventbus)}setOptions(options={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(!isObject(options)){throw new TypeError(`'options' is not an object.`)}if(typeof options.noEventAdd==="boolean"){_classPrivateFieldGet(this,_options).noEventAdd=options.noEventAdd}if(typeof options.noEventDestroy==="boolean"){_classPrivateFieldGet(this,_options).noEventDestroy=options.noEventDestroy}if(typeof options.noEventRemoval==="boolean"){_classPrivateFieldGet(this,_options).noEventRemoval=options.noEventRemoval}if(typeof options.noEventSetEnabled==="boolean"){_classPrivateFieldGet(this,_options).noEventSetEnabled=options.noEventSetEnabled}if(typeof options.noEventSetOptions==="boolean"){_classPrivateFieldGet(this,_options).noEventSetOptions=options.noEventSetOptions}if(typeof options.throwNoMethod==="boolean"){_classPrivateFieldGet(this,_options).throwNoMethod=options.throwNoMethod}if(typeof options.throwNoPlugin==="boolean"){_classPrivateFieldGet(this,_options).throwNoPlugin=options.throwNoPlugin}for(const pluginSupport of _classPrivateFieldGet(this,_pluginSupport)){pluginSupport.setOptions(options)}}_setOptionsEventbus(options={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(!_classPrivateFieldGet(this,_options).noEventSetOptions){this.setOptions(options)}}}function invokeSyncEvent({method,manager,copyProps={},passthruProps={},plugins=void 0,options=void 0,errorCheck=true}={}){if(typeof method!=="string"){throw new TypeError(`'method' is not a string.`)}if(typeof passthruProps!=="object"){throw new TypeError(`'passthruProps' is not an object.`)}if(typeof copyProps!=="object"){throw new TypeError(`'copyProps' is not an object.`)}if(options===void 0){options=manager.getOptions()}if(plugins===void 0){plugins=manager.getPluginMapKeys()}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}let pluginInvokeCount=0;const pluginInvokeNames=[];let hasMethod=false;let hasPlugin=false;const ev=new PluginInvokeEvent(copyProps,passthruProps);if(typeof plugins==="string"){const entry=manager.getPluginEntry(plugins);if(entry!==void 0&&entry.enabled&&entry.instance){hasPlugin=true;if(typeof entry.instance[method]==="function"){ev.eventbus=entry.eventbusProxy;ev.pluginName=entry.name;ev.pluginOptions=entry.data.plugin.options;entry.instance[method](ev);hasMethod=true;pluginInvokeCount++;pluginInvokeNames.push(entry.name)}}}else{for(const name of plugins){const entry=manager.getPluginEntry(name);if(entry!==void 0&&entry.enabled&&entry.instance){hasPlugin=true;if(typeof entry.instance[method]==="function"){ev.eventbus=entry.eventbusProxy;ev.pluginName=entry.name;ev.pluginOptions=entry.data.plugin.options;entry.instance[method](ev);hasMethod=true;pluginInvokeCount++;pluginInvokeNames.push(entry.name)}}}}if(errorCheck&&options.throwNoPlugin&&!hasPlugin){throw new Error(`PluginManager failed to find any target plugins.`)}if(errorCheck&&options.throwNoMethod&&!hasMethod){throw new Error(`PluginManager failed to invoke '${method}'.`)}ev.data.$$plugin_invoke_count=pluginInvokeCount;ev.data.$$plugin_invoke_names=pluginInvokeNames;return ev.data}var _pluginManager=new WeakMap;class PluginInvokeSupport{constructor(pluginManager){_pluginManager.set(this,{writable:true,value:null});_classPrivateFieldSet(this,_pluginManager,pluginManager)}get isDestroyed(){return _classPrivateFieldGet(this,_pluginManager)===null||_classPrivateFieldGet(this,_pluginManager).isDestroyed}get options(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return _classPrivateFieldGet(this,_pluginManager).getOptions()}get pluginManager(){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return _classPrivateFieldGet(this,_pluginManager)}async destroy({eventbus,eventPrepend}={}){if(eventbus!==null&&eventbus!==void 0){eventbus.off(`${eventPrepend}:async:invoke`,this.invokeAsync,this);eventbus.off(`${eventPrepend}:async:invoke:event`,this.invokeAsyncEvent,this);eventbus.off(`${eventPrepend}:get:method:names`,this.getMethodNames,this);eventbus.off(`${eventPrepend}:has:method`,this.hasMethod,this);eventbus.off(`${eventPrepend}:invoke`,this.invoke,this);eventbus.off(`${eventPrepend}:sync:invoke`,this.invokeSync,this);eventbus.off(`${eventPrepend}:sync:invoke:event`,this.invokeSyncEvent,this)}_classPrivateFieldSet(this,_pluginManager,null)}getMethodNames({enabled=void 0,plugins=[]}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(enabled!==void 0&&typeof enabled!=="boolean"){throw new TypeError(`'enabled' is not a boolean.`)}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}if(typeof plugins==="string"){plugins=[plugins]}const anyEnabledState=enabled===void 0;const results={};let count=0;for(const name of plugins){const entry=this.pluginManager.getPluginEntry(name);if(entry!==void 0&&entry.instance&&(anyEnabledState||entry.enabled===enabled)){for(const _name of s_GET_ALL_PROPERTY_NAMES(entry.instance)){if(typeof entry.instance[_name]==="function"&&_name!=="constructor"){results[_name]=true}}}count++}if(count===0){for(const entry of this.pluginManager.getPluginMapValues()){if(entry.instance&&(anyEnabledState||entry.enabled===enabled)){for(const name of s_GET_ALL_PROPERTY_NAMES(entry.instance)){if(typeof entry.instance[name]==="function"&&name!=="constructor"){results[name]=true}}}}}return Object.keys(results).sort()}hasMethod({method,plugins=[]}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof method!=="string"){throw new TypeError(`'method' is not a string.`)}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}if(typeof plugins==="string"){const entry=this.pluginManager.getPluginEntry(plugins);return entry!==void 0&&typeof entry.instance[method]==="function"}let count=0;for(const name of plugins){const entry=this.pluginManager.getPluginEntry(name);if(entry!==void 0&&typeof entry.instance[method]!=="function"){return false}count++}if(count===0){for(const entry of this.pluginManager.getPluginMapValues()){if(typeof entry.instance[method]!=="function"){return false}}}return true}invoke({method,args=void 0,plugins=void 0}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof method!=="string"){throw new TypeError(`'method' is not a string.`)}if(args!==void 0&&!Array.isArray(args)){throw new TypeError(`'args' is not an array.`)}if(plugins===void 0){plugins=this.pluginManager.getPluginMapKeys()}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}let hasMethod=false;let hasPlugin=false;const isArgsArray=Array.isArray(args);if(typeof plugins==="string"){const entry=this.pluginManager.getPluginEntry(plugins);if(entry!==void 0&&entry.enabled&&entry.instance){hasPlugin=true;if(typeof entry.instance[method]==="function"){isArgsArray?entry.instance[method](...args):entry.instance[method]();hasMethod=true}}}else{for(const name of plugins){const entry=this.pluginManager.getPluginEntry(name);if(entry!==void 0&&entry.enabled&&entry.instance){hasPlugin=true;if(typeof entry.instance[method]==="function"){isArgsArray?entry.instance[method](...args):entry.instance[method]();hasMethod=true}}}}if(this.options.throwNoPlugin&&!hasPlugin){throw new Error(`PluginManager failed to find any target plugins.`)}if(this.options.throwNoMethod&&!hasMethod){throw new Error(`PluginManager failed to invoke '${method}'.`)}}async invokeAsync({method,args=void 0,plugins=void 0}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof method!=="string"){throw new TypeError(`'method' is not a string.`)}if(args!==void 0&&!Array.isArray(args)){throw new TypeError(`'args' is not an array.`)}if(plugins===void 0){plugins=this.pluginManager.getPluginMapKeys()}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}let hasMethod=false;let hasPlugin=false;let result=void 0;const results=[];const isArgsArray=Array.isArray(args);if(typeof plugins==="string"){const plugin=this.pluginManager.getPluginEntry(plugins);if(plugin!==void 0&&plugin.enabled&&plugin.instance){hasPlugin=true;if(typeof plugin.instance[method]==="function"){result=isArgsArray?plugin.instance[method](...args):plugin.instance[method]();if(result!==void 0){results.push(result)}hasMethod=true}}}else{for(const name of plugins){const plugin=this.pluginManager.getPluginEntry(name);if(plugin!==void 0&&plugin.enabled&&plugin.instance){hasPlugin=true;if(typeof plugin.instance[method]==="function"){result=isArgsArray?plugin.instance[method](...args):plugin.instance[method]();if(result!==void 0){results.push(result)}hasMethod=true}}}}if(this.options.throwNoPlugin&&!hasPlugin){throw new Error(`PluginManager failed to find any target plugins.`)}if(this.options.throwNoMethod&&!hasMethod){throw new Error(`PluginManager failed to invoke '${method}'.`)}return results.length>1?Promise.all(results).then((values=>{const filtered=values.filter((entry=>entry!==void 0));switch(filtered.length){case 0:return void 0;case 1:return filtered[0];default:return filtered}})):result}async invokeAsyncEvent({method,copyProps={},passthruProps={},plugins=void 0}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return invokeAsyncEvent({method,manager:this.pluginManager,copyProps,passthruProps,plugins})}invokeSync({method,args=void 0,plugins=void 0}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(typeof method!=="string"){throw new TypeError(`'method' is not a string.`)}if(args!==void 0&&!Array.isArray(args)){throw new TypeError(`'args' is not an array.`)}if(plugins===void 0){plugins=this.pluginManager.getPluginMapKeys()}if(typeof plugins!=="string"&&!isIterable(plugins)){throw new TypeError(`'plugins' is not a string or iterable.`)}let hasMethod=false;let hasPlugin=false;let result=void 0;const results=[];const isArgsArray=Array.isArray(args);if(typeof plugins==="string"){const plugin=this.pluginManager.getPluginEntry(plugins);if(plugin!==void 0&&plugin.enabled&&plugin.instance){hasPlugin=true;if(typeof plugin.instance[method]==="function"){result=isArgsArray?plugin.instance[method](...args):plugin.instance[method]();if(result!==void 0){results.push(result)}hasMethod=true}}}else{for(const name of plugins){const plugin=this.pluginManager.getPluginEntry(name);if(plugin!==void 0&&plugin.enabled&&plugin.instance){hasPlugin=true;if(typeof plugin.instance[method]==="function"){result=isArgsArray?plugin.instance[method](...args):plugin.instance[method]();if(result!==void 0){results.push(result)}hasMethod=true}}}}if(this.options.throwNoPlugin&&!hasPlugin){throw new Error(`PluginManager failed to find any target plugins.`)}if(this.options.throwNoMethod&&!hasMethod){throw new Error(`PluginManager failed to invoke '${method}'.`)}return results.length>1?results:result}invokeSyncEvent({method,copyProps={},passthruProps={},plugins=void 0}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}return invokeSyncEvent({method,manager:this.pluginManager,copyProps,passthruProps,plugins})}setEventbus({oldEventbus,newEventbus,oldPrepend,newPrepend}={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}if(oldEventbus!==null&&oldEventbus!==void 0){oldEventbus.off(`${oldPrepend}:async:invoke`,this.invokeAsync,this);oldEventbus.off(`${oldPrepend}:async:invoke:event`,this.invokeAsyncEvent,this);oldEventbus.off(`${oldPrepend}:get:method:names`,this.getMethodNames,this);oldEventbus.off(`${oldPrepend}:has:method`,this.hasMethod,this);oldEventbus.off(`${oldPrepend}:invoke`,this.invoke,this);oldEventbus.off(`${oldPrepend}:sync:invoke`,this.invokeSync,this);oldEventbus.off(`${oldPrepend}:sync:invoke:event`,this.invokeSyncEvent,this)}if(newEventbus!==null&&newEventbus!==void 0){newEventbus.on(`${newPrepend}:async:invoke`,this.invokeAsync,this,true);newEventbus.on(`${newPrepend}:async:invoke:event`,this.invokeAsyncEvent,this,true);newEventbus.on(`${newPrepend}:get:method:names`,this.getMethodNames,this,true);newEventbus.on(`${newPrepend}:has:method`,this.hasMethod,this,true);newEventbus.on(`${newPrepend}:invoke`,this.invoke,this,true);newEventbus.on(`${newPrepend}:sync:invoke`,this.invokeSync,this,true);newEventbus.on(`${newPrepend}:sync:invoke:event`,this.invokeSyncEvent,this,true)}}setOptions(options={}){if(this.isDestroyed){throw new ReferenceError("This PluginManager instance has been destroyed.")}}}const s_GET_ALL_PROPERTY_NAMES=obj=>{const props=[];do{Object.getOwnPropertyNames(obj).forEach((prop=>{if(props.indexOf(prop)===-1){props.push(prop)}}));obj=Object.getPrototypeOf(obj)}while(obj!==void 0&&obj!==null&&!(obj===Object.prototype));return props};export default PluginManager;export{p as Eventbus,y as EventbusProxy,i as EventbusSecure,PluginInvokeSupport,escapeTarget,J as eventbus,isValidConfig,z as pluginEventbus,L as testEventbus};
//# sourceMappingURL=PluginManager.js.map
